---
title: About the aws_iam_policy Resource
platform: aws
---

# aws\_iam\_policy

Use the `aws_iam_policy` InSpec audit resource to test detailed properties of a single managed AWS IAM Policy.  Use `aws_iam_policies` to audit IAM policies in bulk.

A policy is an entity in AWS that, when attached to an identity or resource, defines their permissions. AWS evaluates these policies when a principal, such as a user, makes a request. Permissions (known as Statements) in the policies determine if the request is allowed or denied.

Each IAM Policy is uniquely identified by either its policy\_name or arn.

<br>

## Syntax

An `aws_iam_policy` resource block identifies a policy by policy name.

    # Find a policy by name
    describe aws_iam_policy('AWSSupportAccess') do
      it { should exist }
    end

    # Find a customer-managed by name
    describe aws_iam_policy('customer-managed-policy') do
      it { should exist }
    end

    # Hash syntax for policy name
    describe aws_iam_policy(policy_name: 'AWSSupportAccess') do
      it { should exist }
    end

<br>

## Examples

The following examples show how to use this InSpec audit resource.

### Test that a policy does exist

    describe aws_iam_policy('AWSSupportAccess') do
      it { should exist }
    end

### Test that a policy is attached to at least one entity

    describe aws_iam_policy('AWSSupportAccess') do
      it { should be_attached }
    end

### Examine the policy statements

    describe aws_iam_policy('my-policy') do
      # Verify that there is at least one statement allowing access to S3
      it { should have_statement(Action: 's3:PutObject', Effect: 'allow') }

      # have_statement does not expand wildcards.  If you want to verify 
      # they are absent, an explicit check is required.
      it { should_not have_statement(Action: 's3:*') }
    end

<br>

## Properties

* `arn`, `attachment_count`, `attached_groups`, `attached_roles`,`attached_users`, `default_version_id`, `policy`, `statement_count`

## Property Examples

### arn

"The ARN identifier of the specified policy. An ARN uniquely identifies the policy within AWS."

    describe aws_iam_policy('AWSSupportAccess') do
      its('arn') { should cmp "arn:aws:iam::aws:policy/AWSSupportAccess" }
    end

### attachment\_count

The count of attached entities for the specified policy.

    describe aws_iam_policy('AWSSupportAccess') do
      its('attachment_count') { should cmp 1 }
    end

### attached\_groups

The list of groupnames of the groups attached to the policy.

    describe aws_iam_policy('AWSSupportAccess') do
      its('attached_groups') { should include "test-group" }
    end

### attached\_roles

The list of rolenames of the roles attached to the policy.

    describe aws_iam_policy('AWSSupportAccess') do
      its('attached_roles') { should include "test-role" }
    end

### attached\_users

The list of usernames of the users attached to the policy.

    describe aws_iam_policy('AWSSupportAccess') do
      its('attached_users') { should include "test-user" }
    end

### default\_version\_id

The 'default_version_id' value of the specified policy.

    describe aws_iam_policy('AWSSupportAccess') do
      its('default_version_id') { should cmp "v1" }
    end

### policy

A low-level property that returns a Ruby Hash structure reflecting the decoded contents of the default version of the policy's policy document. This structure contains the statements that the policy enforces and is useful for performing checks that cannot be expressed using higher-level matchers like `have_statement`.

For details regarding the contents of this structure, refer to the [AWS IAM Policy JSON Reference](https://docs.aws.amazon.com/IAM/latest/UserGuide/reference_policies.html).  A set of examples is [also available](https://docs.aws.amazon.com/IAM/latest/UserGuide/access_policies_examples.html).

Example: 

    describe aws_iam_policy('my-policy') do
      # TODO - example?
      its('policy') { should }
    end

### statement\_count

Returns the number of Statements present in the `policy`.

    # Make sure there are exactly two statements.
    describe aws_iam_policy('my-policy') do
      its('statement_count') { should cmp 2 }
    end

## Matchers

This InSpec audit resource has the following special matchers. For a full list of available matchers, please visit our [Universal Matchers page](https://www.inspec.io/docs/reference/matchers/).

### be\_attached

The test will pass if the identified policy is attached to at least one IAM user, group, or role.

    describe aws_iam_policy('AWSSupportAccess') do
      it { should be_attached }
    end

### be\_attached\_to\_group(GROUPNAME)

The test will pass if the identified policy attached the specified group.

    describe aws_iam_policy('AWSSupportAccess') do
      it { should be_attached_to_group(GROUPNAME) }
    end

### be\_attached\_to\_user(USERNAME)

The test will pass if the identified policy attached the specified user.

    describe aws_iam_policy('AWSSupportAccess') do
      it { should be_attached_to_user(USERNAME) }
    end

### be\_attached\_to\_role(ROLENAME)

The test will pass if the identified policy attached the specified role.

    describe aws_iam_policy('AWSSupportAccess') do
      it { should be_attached_to_role(ROLENAME) }
    end

### have\_statement

Examines the list of statements contained in the policy, and passes if at least one of the statements matches. Note that this does _not_ interpret the policy in a request authorization context, as AWS does when a request processed. Rather, `have_statement` examines the literal contents of the IAM policy, and reports on what is present (or absent, when used with `should_not`).

`have_statement` accepts the following criteria to search for matching statements. If any statement matches all the criteria, the test is successful.

* `Action` - Expresses the operation being requested. Acceptable literal values are any AWS operation name, including the '*' wildcard character. `Action` may also be a list of such values.
* `Effect` - Expresses whether the operation is permitted. Acceptable values are 'Deny' and 'Allow'.
* `Id` - A user-provided string identifier for the statement.
* `Principal` - Refers to the actor making the request. May be an ARN, a service identifier, or a wildcard. `Principal` may also be a list of such values.
* `Resource` - Expresses the target of the operation. Acceptable values are ARNs, including the '*' wildcard. `Resource` may also be a list of such values.

Please note the following about the behavior of `have_statement`:
* `Action`, `Id`, `Principal`, and `Resource` allow using a regular expression instead of a string literal as the search criteria.
* it does not support wildcard expansion; if you wish to check for a wildcard value, you must check for it explicitly. For example, if the policy includes a statement with `"Action": "s3:*"` and you write a test checking for `Action: "s3:PutObject"`, your test _will not match_.  You must write an additional test checking for the wildcard case. 
* it does support searching list values.  For example, if a statement contains a list of 3 resources, and you write a `have_statement` test specifying one of those resources, it will match.
* `Action`, `Principal`, and `Resource` allow providing a list of string literals or regular expressions, in which case _all_ must match on the _same_ statement for the test to match. Order is ignored.
* it does not currently support the `Conditional` key, nor any of `NotAction`, `NotPrincipal`, or `NotResource`.

Examples:

    # Verify there is no full-admin statement
    describe aws_iam_policy('kryptonite') do
      it { should_not have_statement(Effect: 'Allow', Resource: '*', Action: '*')}
    end

    # Verify bob is allowed to manage things on S3 buckets that start with bobs-stuff
    describe aws_iam_policy('bob-is-a-packrat') do
      it { should have_statement(Effect: 'Allow',
                                 Principal: 'arn:aws:iam::123456789101:user/bob'
                                 # Using the AWS wildcard - this must match exactly 
                                 Resource: 'arn:aws:s3:::bobs-stuff*',
                                 # Specify a list of actions - all must match, no others, order isn't important
                                 Action: ['s3:PutObject', 's3:GetObject', 's3:DeleteObject'])}

      # Bob would make new buckets constantly if we let him.
      it { should_not have_statement(Effect: 'Allow', Action: 's3:CreateBucket')}
      it { should_not have_statement(Effect: 'Allow', Action: 's3:*')}
      it { should_not have_statement(Effect: 'Allow', Action: '*')}

      # An alternative to checking for wildcards is to specify the 
      # statements you expect, then restrict statement count
      its('statement_count') { should cmp 1 }
    end

    # Use regular expressions to examine the policy
    describe aws_iam_policy('regex-demo') do
      # Check to see if anything mentions RDS at all.
      # This catches `rds:CreateDBinstance` and `rds:*`, but would not catch '*'.
      it { should_not have_statement(Action: /^rds:/)}
      
      # This policy should refer to both sally and kim's s3 buckets.
      # This will only match if there is a statement that refers to both resources.
      it { should have_statement(Resource: [/arn:aws:s3.+:sally/, /arn:aws:s3.+:kim/]) }
      # This isn't quite the same; it would also match on a statement that only mentions one of them
      it { should have_statement(Resource: /arn:aws:s3.+:(sally|kim)/) }
    end


### grant_full_admin

This high-level matcher detects whether the policy contains a statement that grants "full admin" permissions on the AWS account.  More precisely, the matcher looks for any statement with:

* Effect: 'Allow'
* Resource: '*'
* Action: '*'

Examples:

    # Allow full admin for the 'admins' policy
    describe aws_iam_policy('admins') do
      it { should grant_full_admin }
    end

    # Peons should not have admin.
    describe aws_iam_policy('peons') do
      it { should_not grant_full_admin }
    end
